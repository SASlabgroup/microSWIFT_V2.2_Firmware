/*
 * error_handler.c
 *
 *  Created on: Aug 22, 2024
 *      Author: philbush
 */

#include "error_handler.h"
#include "threadx_support.h"
#include "persistent_ram.h"
#include "app_threadx.h"
#include "main.h"

void Error_Handler ( void )
{
  __disable_irq ();

  safe_mode ();

  persistent_ram_deinit ();

  while ( 1 )
  {
    HAL_NVIC_SystemReset ();
  }
}

void safe_mode ( void )
{
  // Shut down all interfaces
  i2c2_deinit ();
  lpuart1_deinit ();
  octospi1_deinit ();
  sdmmc1_deinit ();

  // Turn everything off
  HAL_GPIO_WritePin (CT_FET_GPIO_Port, CT_FET_Pin, GPIO_PIN_RESET);
  HAL_GPIO_WritePin (RF_SWITCH_VCTL_GPIO_Port, RF_SWITCH_VCTL_Pin, GPIO_PIN_RESET);
  HAL_GPIO_WritePin (GNSS_FET_GPIO_Port, GNSS_FET_Pin, GPIO_PIN_RESET);
  HAL_GPIO_WritePin (BUS_5V_FET_GPIO_Port, BUS_5V_FET_Pin, GPIO_PIN_RESET);
  HAL_GPIO_WritePin (SD_CARD_FET_GPIO_Port, SD_CARD_FET_Pin, GPIO_PIN_RESET);
  HAL_GPIO_WritePin (RS232_FORCEOFF_GPIO_Port, RS232_FORCEOFF_Pin, GPIO_PIN_RESET);
  HAL_GPIO_WritePin (LED_GREEN_GPIO_Port, LED_GREEN_Pin, GPIO_PIN_RESET);
  HAL_GPIO_WritePin (LED_RED_GPIO_Port, LED_RED_PinLED_RED_Pin, GPIO_PIN_RESET);
  HAL_GPIO_WritePin (TEMPERATURE_FET_GPIO_Port, TEMPERATURE_FET_Pin, GPIO_PIN_RESET);
  HAL_GPIO_WritePin (TURBIDITY_FET_GPIO_Port, TURBIDITY_FET_Pin, GPIO_PIN_RESET);
  HAL_GPIO_WritePin (LIGHT_FET_GPIO_Port, LIGHT_FET_Pin, GPIO_PIN_RESET);
  HAL_GPIO_WritePin ( RTC_WDOG_OR_INPUT_GPIO_Port, RTC_WDOG_OR_INPUT_Pin, GPIO_PIN_RESET);

  // Short delay
  HAL_Delay (10);
}
